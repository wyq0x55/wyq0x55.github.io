---
categories: [通信, 诊断]
tags: [通信,车载]
mermaid: true
---

本文是本人学习UDS诊断是总结文档，如有错误希望能指出

# UDS OSI模型
![Desktop View](/_posts/20241014/UDS_ISO.png){: width="972" height="589" }

_根据OSI模型实现UDS文档参考_

# 应用层服务

| 服务                            | SID  | 描述                              |
| ------------------------------- | ---- | --------------------------------- |
| DiagnosticSessionControl        | 0x10 | 客户端请求控制与服务器的诊断会话  |
| ECUReset                        | 0x11 | 复位ECU（电子控制单元）           |
| SecurityAccess                  | 0x27 | 安全访问                          |
| CommunicationControl            | 0x28 | 通信控制                          |
| TesterPresent                   | 0x3E | 测试器 Present                    |
| AccessTimingParameter           | 0x83 | 访问 timing 参数                  |
| SecuredDataTransmission         | 0x84 | 安全数据传输                      |
| ControlDTCSetting               | 0x85 | 控制 DTC（诊断 trouble code）设置 |
| ResponseOnEvent                 | 0x86 | 响应事件                          |
| LinkControl                     | 0x87 | 链接控制                          |
| ReadDataByIdentifier            | 0x22 | 通过标识符读取数据                |
| ReadMemoryByAddress             | 0x23 | 通过地址读取内存                  |
| ReadScalingDataByIdentifier     | 0x24 | 通过标识符读取缩放数据            |
| ReadDataByPeriodicIdentifier    | 0x2A | 通过周期标识符读取数据            |
| DynamicallyDefineDataIdentifier | 0x2C | 动态定义数据标识符                |
| WriteDataByIdentifier           | 0x2E | 通过标识符写入数据                |
| WriteMemoryByAddress            | 0x3D | 通过地址写入内存                  |
| ClearDiagnosticInformation      | 0x14 | 清除诊断信息                      |
| ReadDTCInformation              | 0x19 | 读取 DTC 信息                     |
| InputOutputControlByIdentifier  | 0x2F | 输入/输出控制通过标识符           |
| RoutineControl                  | 0x31 | routine 控制                      |
| requestDownload                 | 0x34 | 请求下载                          |
| requestUpload                   | 0x35 | 请求上传                          |
| TransferData                    | 0x36 | 传输数据                          |
| RequestTransferExit             | 0x37 | 请求传输退出                      |
| RequestFileTransfer             | 0x38 | 请求文件传输                      |



## 寻址的客户端类别

| 寻址方式 | CANID             | 发送源  | 接收源  |
| -------- | ----------------- | ------- | ------- |
| 功能寻址 | 功能寻址 CANID    | Tester  | All ECU |
| 物理寻址 | 指定ECU 受信CANID | Tester  | 指定ECU |
| 物理寻址 | 指定ECU 送信CANID | 指定ECU | Tester  |

## 请求帧格式 request message

```mermaid
packet-beta
title UDS CAN Packet
0-7: "CAN ID"
8-15: "SID"
16: "Length"
17-24: "subfunction"
25-63: "Data (request parameter)"
```

## DiagnosticSessionControl(0x10)服务

DiagnosticSessionControl服务用于在服务器中启用不同的诊断会话。

### request message

| A_Data字节 | 参数名称                        | Cvt | 字节值    | 助记符  |
| ---------- | ------------------------------- | --- | --------- | ------- |
| #1         | DiagnosticSessionControl请求SID | M   | 0x10      | DSC     |
| #2         | 子函数=[diagnosticSessionType]  | M   | 0x00-0xFF | LEV_DS_ |

++ diagnosticSessionType

| subfunction                            | ID  | 描述                 |
| -------------------------------------- | --- | -------------------- |
| DefaultSession                         | 0   | 默认会话             |
| ProgrammingSession                     | 1   | 编程会话             |
| ExtendedDiagnosticSession              | 2   | 扩展诊断会话         |
| SafetySystemDiagnosticSession          | 3   | 安全系统诊断会话     |
| EmissionRelatedSystemDiagnosticSession | 4   | 排放相关系统诊断会话 |
| OBDIIComplianceSession                 | 5   | OBDII合规性会话      |
| UDSComplianceSession                   | 6   | UDS合规性会话        |
| ECUResetSession                        | 7   | ECU重置会话          |


### 肯定应答（Positive Response）

| A_Data字节 | 参数名称                        | Cvt | 字节值      | 助记符  |
| ---------- | ------------------------------- | --- | ----------- | ------- |
| #1         | DiagnosticSessionControl响应SID | M   | 0x50(10+40) | DSC     |
| #2         | 子函数=[diagnosticSessionType]  | M   | 0x00-0xFF   | LEV_DS_ |
| #3         | sessionParameterRecord          | M   | 0x00-0xFF   | SPSR    |

> sessionParameterRecord->
> 
> | 参数           | 描述                                                      | 字节数 | 解析度 | 最小值 | 最大值      |
> | -------------- | --------------------------------------------------------- | ------ | ------ | ------ | ----------- |
> | P2Server\_max  | 服务器支持激活的诊断会话的默认P2Server\_max计时。         | 2      | 1毫秒  | 0毫秒  | 65 535毫秒  |
> | P2*Server\_max | 增强型（NRC 0x78）P2Server\_max服务器支持激活的诊断会话。 | 2      | 10毫秒 | 0毫秒  | 655 350毫秒 |
> 
> 注意：这里的解析度和最小值/最大值是针对P2Server\_max参数的说明，具体含义可能因应用场景和设备而异。如有需要，请根据实际设备和应用场景进行调整。



### 否定应答（Negative Response）

| A_Data字节 | 参数名称                        | Cvt | 字节值    | 助记符  |
| ---------- | ------------------------------- | --- | --------- | ------- |
| #1         | DiagnosticSessionControl响应SID | M   | 0x7F(127) | DSC     |
| #2         | 子函数=[diagnosticSessionType]  | M   | 0x00-0xFF | LEV_DS_ |
| #3         | sessionParameterRecord          | M   | 0x00-0xFF | SPSR    |


### 诊断会话控制（DiagnosticSessionControl）

| SID  | 助记符   | 描述         |
| ---- | -------- | ------------ |
| 0x10 | DSC      | 诊断会话控制 |
| 0x11 | ECUReset | ECU重置      |
